"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3030],{3905:function(e,n,a){a.d(n,{Zo:function(){return c},kt:function(){return f}});var r=a(7294);function t(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function i(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,r)}return a}function o(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?i(Object(a),!0).forEach((function(n){t(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function l(e,n){if(null==e)return{};var a,r,t=function(e,n){if(null==e)return{};var a,r,t={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],n.indexOf(a)>=0||(t[a]=e[a]);return t}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(t[a]=e[a])}return t}var s=r.createContext({}),p=function(e){var n=r.useContext(s),a=n;return e&&(a="function"==typeof e?e(n):o(o({},n),e)),a},c=function(e){var n=p(e.components);return r.createElement(s.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},m=r.forwardRef((function(e,n){var a=e.components,t=e.mdxType,i=e.originalType,s=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),m=p(a),f=t,d=m["".concat(s,".").concat(f)]||m[f]||u[f]||i;return a?r.createElement(d,o(o({ref:n},c),{},{components:a})):r.createElement(d,o({ref:n},c))}));function f(e,n){var a=arguments,t=n&&n.mdxType;if("string"==typeof e||t){var i=a.length,o=new Array(i);o[0]=m;var l={};for(var s in n)hasOwnProperty.call(n,s)&&(l[s]=n[s]);l.originalType=e,l.mdxType="string"==typeof e?e:t,o[1]=l;for(var p=2;p<i;p++)o[p]=a[p];return r.createElement.apply(null,o)}return r.createElement.apply(null,a)}m.displayName="MDXCreateElement"},4381:function(e,n,a){a.r(n),a.d(n,{assets:function(){return c},contentTitle:function(){return s},default:function(){return f},frontMatter:function(){return l},metadata:function(){return p},toc:function(){return u}});var r=a(7462),t=a(3366),i=(a(7294),a(3905)),o=["components"],l={sidebar_position:7},s="Examples",p={unversionedId:"examples",id:"examples",title:"Examples",description:"Multiple Source Profiles",source:"@site/docs/examples.md",sourceDirName:".",slug:"/examples",permalink:"/docs/examples",editUrl:"https://github.com/aripalo/vegas-credentials/tree/main/packages/create-docusaurus/templates/shared/docs/examples.md",tags:[],version:"current",sidebarPosition:7,frontMatter:{sidebar_position:7},sidebar:"tutorialSidebar",previous:{title:"Logs",permalink:"/docs/logs"},next:{title:"Network Connections",permalink:"/docs/network-connections"}},c={},u=[{value:"Multiple Source Profiles",id:"multiple-source-profiles",level:2},{value:"AWS SDKs",id:"aws-sdks",level:2},{value:"Role Chaining",id:"role-chaining",level:2},{value:"Terraform",id:"terraform",level:2},{value:"Parallelism",id:"parallelism",level:3},{value:"Ansible",id:"ansible",level:2}],m={toc:u};function f(e){var n=e.components,l=(0,t.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},m,l,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"examples"},"Examples"),(0,i.kt)("h2",{id:"multiple-source-profiles"},"Multiple Source Profiles"),(0,i.kt)("p",null,"Let's say you have an AWS IAM user for work stuff and another for your hobby project, both which you use to assume roles. This can be achieved with following example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ini"},"# ~/.aws/config\n[profile work]\nmfa_serial = arn:aws:iam::111111111111:mfa/FrankSinatra\n\n[profile hobby]\nmfa_serial = arn:aws:iam::999999999999:mfa/Frankie\n\n[profile frank@concerts]\ncredential_process = vegas-credentials assume --profile=frank@concerts\nvegas_role_arn=arn:aws:iam::222222222222:role/SingerRole\nvegas_source_profile=work\n\n[profile frankie@painting]\ncredential_process = vegas-credentials assume --profile=frankie@painting\nvegas_role_arn=arn:aws:iam::888888888888:role/PainterRole\nvegas_source_profile=hobby\n")),(0,i.kt)("h2",{id:"aws-sdks"},"AWS SDKs"),(0,i.kt)("p",null,"Often times you may not want to define the ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," within the application code, since the application code most often will be ran without profile in cloud. You may circumvent this by setting the profile via ",(0,i.kt)("inlineCode",{parentName:"p"},"AWS_PROFILE")," environment variable. Most AWS SDKs should support this. Example with running a NodeJS based script (that does something with AWS SDK):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"AWS_PROFILE=frank@concerts node index.js\n")),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},(0,i.kt)("em",{parentName:"p"},"By default, the SDK checks the ",(0,i.kt)("inlineCode",{parentName:"em"},"AWS_PROFILE")," environment variable to determine which profile to use. If the ",(0,i.kt)("inlineCode",{parentName:"em"},"AWS_PROFILE")," variable is not set in your environment, the SDK uses the credentials for the ",(0,i.kt)("inlineCode",{parentName:"em"},"[default]")," profile. To use one of the alternate profiles, set or change the value of the ",(0,i.kt)("inlineCode",{parentName:"em"},"AWS_PROFILE")," environment variable. For example, given the configuration file shown, to use the credentials from the work account, set the ",(0,i.kt)("inlineCode",{parentName:"em"},"AWS_PROFILE")," environment variable to work-account (as appropriate for your operating system).")),(0,i.kt)("p",{parentName:"blockquote"},"\u2013 ",(0,i.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/loading-node-credentials-shared.html"},"AWS SDK v3 docs"))),(0,i.kt)("h2",{id:"role-chaining"},"Role Chaining"),(0,i.kt)("p",null,"This tool also supports role chaining - ",(0,i.kt)("strong",{parentName:"p"},"given that the specific AWS tool your using supports it")," - which means assuming an initial role and then using it to assume another role. An example with 3 different AWS accounts would look like:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"role-chaining",src:a(5049).Z,width:"1562",height:"242"})),(0,i.kt)("br",null),(0,i.kt)("p",null,"Assuming correct IAM roles exists with valid permissions and trust policies:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Assuming you have the following configuration already:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini"},"# ~/.aws/credentials\n[default]\naws_access_key_id = AKIAIOSFODNN7EXAMPLE\naws_secret_access_key = wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY\n")),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini"},"# ~/.aws/config\n[default]\naws_mfa_device = arn:aws:iam::111111111111:mfa/FrankSinatra\n\n[profile frank@concerts]\ncredential_process = vegas-credentials assume --profile=frank@concerts\nvegas_role_arn=arn:aws:iam::222222222222:role/SingerRole\nvegas_source_profile=default\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Configure another role with standard ",(0,i.kt)("inlineCode",{parentName:"p"},"role_arn")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"source_profile"),":"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-ini"},"# ~/.aws/config\n[profile frank@movies]\nrole_arn=arn:aws:iam::333333333333:role/ActorRole # Important: NO prefix here!\nsource_profile=frank@concerts # Important: NO prefix here!\n"))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("p",{parentName:"li"},"Do some chaining:"),(0,i.kt)("pre",{parentName:"li"},(0,i.kt)("code",{parentName:"pre",className:"language-shell"},"aws sts get-caller-identity --profile frank@movies\n")))),(0,i.kt)("h2",{id:"terraform"},"Terraform"),(0,i.kt)("p",null,"Use Terraform AWS Provider to define your resources and define variable ",(0,i.kt)("inlineCode",{parentName:"p"},"aws_profile"),":"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tf"},'terraform {\n  required_providers {\n    aws = {\n      source  = "hashicorp/aws"\n      version = "~> 3.27"\n    }\n  }\n\n  required_version = ">= 0.14.9"\n}\n\nvariable "aws_profile" {\n  type = string\n}\n\n# Again, nothing special here, just normal profile configuration\u2026\nprovider "aws" {\n  profile = var.aws_profile\n  region  = "eu-west-3"\n}\n\ndata "aws_region" "current" {}\n\noutput "album_name" {\n  value = "Sinatra & Sextet: Live in ${\n    replace(\n      regex("[a-zA-Z]+\\\\)$", data.aws_region.current.description),\n      ")",\n      ""\n    )\n  }"\n}\n')),(0,i.kt)("p",null,"Run Terraform and define the profile (for example via CLI ",(0,i.kt)("inlineCode",{parentName:"p"},"-var")," flag):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'terraform apply -var="aws_profile=frank@concerts\n')),(0,i.kt)("h3",{id:"parallelism"},"Parallelism"),(0,i.kt)("p",null,"Terraform ",(0,i.kt)("a",{parentName:"p",href:"https://www.terraform.io/cli/commands/apply#parallelism-n"},"performs operations in parallel")," which means that it ends up invoking the ",(0,i.kt)("inlineCode",{parentName:"p"},"credential_process")," (and therefore ",(0,i.kt)("inlineCode",{parentName:"p"},"vegas-credentials assume")," command) multiple times concurrently; This is okay, as this tool now has support for parallelism where each process invocation uses ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/alexflint/go-filemutex"},(0,i.kt)("inlineCode",{parentName:"a"},"go-filemutex"))," to obtain a file lock or wait until a lock can be acquired (i.e. wait until another process invocation has finished): This results into a queued authentication flow where the first invocation of ",(0,i.kt)("inlineCode",{parentName:"p"},"vegas-credentials assume")," prompting for MFA token (unless valid temporary session credentials were already available from cache) and consecutive invocations receiving the temporary session credentials from cache."),(0,i.kt)("h2",{id:"ansible"},"Ansible"),(0,i.kt)("p",null,"Define your AWS resources with Ansible as usual, but add ",(0,i.kt)("inlineCode",{parentName:"p"},"profile")," key in which you may use a variable that could be set via command-line ",(0,i.kt)("inlineCode",{parentName:"p"},"--extra-vars")," for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},'---\n- name: Create Bucket\n  hosts: local\n  connection: local\n  vars:\n    aws_profile:\n  tasks:\n    - name: Create new bucket\n      aws_s3:\n        bucket: franks-bcuket\n        mode: create\n        region: us-west-1\n        profile: "{{ aws_profile }}"\n')),(0,i.kt)("p",null,"Run it:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-bash"},'ansible-playbook -i hosts tasks.yml --extra-vars "aws_profile=frank@concerts"\n')))}f.isMDXComponent=!0},5049:function(e,n,a){n.Z=a.p+"assets/images/role-chaining-a142b28d71e52ccd9f14c90aea6d1e83.svg"}}]);